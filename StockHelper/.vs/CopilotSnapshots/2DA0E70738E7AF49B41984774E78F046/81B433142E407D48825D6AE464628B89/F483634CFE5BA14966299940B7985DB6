using Services.Contracts.CustomException;
using Services.Contracts.Logs;
using Services.DAL.Implementations.Repositories;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Services.Implementations
{
    /// <summary>
    /// Service for managing application language and translations.
    /// Provides culture management and translation services.
    /// </summary>
    public sealed class LanguageService
    {
        #region Singleton
        private readonly static LanguageService _instance = new LanguageService();

        public static LanguageService GetInstance => _instance;

        private LanguageService()
        {
            LoadCultureFromConfig();
        }
        #endregion

        #region Events
        /// <summary>
        /// Event raised when the application language/culture changes.
        /// </summary>
        public event EventHandler LanguageChanged;
        #endregion

        #region Public Methods
        /// <summary>
        /// Translates a word/key using the LanguageRepository.
        /// Automatically adds missing keys to the translation file.
        /// </summary>
        /// <param name="word">The word/key to translate</param>
        /// <returns>Translated string or original word if not found</returns>
        public string Translate(string word)
        {
            if (string.IsNullOrWhiteSpace(word))
            {
                return word;
            }

            try
            {
                // Use instance method instead of static
                return LanguageRepository.GetInstance.Translate(word);
            }
            catch (WordNotFoundException)
            {
                // Word not found - add it to the translation file
                LanguageRepository.GetInstance.AddDatakey(word);
                
                Logger.Current.Warning(
                    $"Translation key '{word}' not found in culture '{GetCurrentCulture()}'. " +
                    $"Added to translation file for future translation.");
                
                return word; // Return the original word
            }
            catch (Exception ex)
            {
                Logger.Current.LogException(LogLevels.Error, 
                    $"Unexpected error translating '{word}'", ex);
                return word;
            }
        }

        /// <summary>
        /// Changes the application culture/language.
        /// </summary>
        /// <param name="cultureName">Culture code (e.g., "es-ES", "en-US")</param>
        public void ChangeCulture(string cultureName)
        {
            if (string.IsNullOrWhiteSpace(cultureName))
            {
                Logger.Current.Warning("Attempted to change to null or empty culture");
                return;
            }

            try
            {
                // Validate culture exists
                CultureInfo culture = new CultureInfo(cultureName);

                // Check if translation file exists for this culture
                if (!LanguageRepository.GetInstance.TranslationFileExists(cultureName))
                {
                    Logger.Current.Warning(
                        $"Translation file not found for culture '{cultureName}'. " +
                        $"Application will use keys as fallback.");
                }

                // Set the culture
                SetCultureInternal(cultureName);

                // Save to config
                SaveCultureToConfig(cultureName);

                // Notify subscribers about the language change
                OnLanguageChanged();

                Logger.Current.Info($"Culture changed successfully to: {cultureName}");
            }
            catch (CultureNotFoundException ex)
            {
                Logger.Current.LogException(LogLevels.Error, 
                    $"Invalid culture: {cultureName}", ex);
                throw;
            }
            catch (Exception ex)
            {
                Logger.Current.LogException(LogLevels.Error, 
                    $"Error changing culture to {cultureName}", ex);
                throw;
            }
        }

        /// <summary>
        /// Gets the current application culture code.
        /// </summary>
        /// <returns>Culture code (e.g., "es-ES")</returns>
        public string GetCurrentCulture()
        {
            return Thread.CurrentThread.CurrentCulture.Name;
        }

        /// <summary>
        /// Gets the current culture info object.
        /// </summary>
        /// <returns>CultureInfo object</returns>
        public CultureInfo GetCurrentCultureInfo()
        {
            return Thread.CurrentThread.CurrentCulture;
        }

        /// <summary>
        /// Gets a list of available translation files/cultures.
        /// </summary>
        /// <returns>List of available culture codes</returns>
        public List<string> GetAvailableCultures()
        {
            List<string> cultures = new List<string>();

            try
            {
                string folderPath = ConfigurationManager.AppSettings["LanguageFolderPath"];
                string fileName = ConfigurationManager.AppSettings["LanguageFileName"];

                if (string.IsNullOrWhiteSpace(folderPath))
                {
                    folderPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "I18n");
                }

                if (!Path.IsPathRooted(folderPath))
                {
                    folderPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, folderPath);
                }

                if (!Directory.Exists(folderPath))
                {
                    Logger.Current.Warning($"Translation folder not found: {folderPath}");
                    return cultures;
                }

                // Find all translation files
                string searchPattern = $"{fileName}.*";
                string[] files = Directory.GetFiles(folderPath, searchPattern);

                foreach (string file in files)
                {
                    // Extract culture from filename (e.g., translations.es-ES -> es-ES)
                    string fileNameOnly = Path.GetFileName(file);
                    int lastDotIndex = fileNameOnly.LastIndexOf('.');
                    
                    if (lastDotIndex > 0 && lastDotIndex < fileNameOnly.Length - 1)
                    {
                        string cultureName = fileNameOnly.Substring(lastDotIndex + 1);
                        
                        // Validate it's a valid culture
                        try
                        {
                            CultureInfo culture = new CultureInfo(cultureName);
                            cultures.Add(cultureName);
                        }
                        catch (CultureNotFoundException)
                        {
                            // Skip invalid culture names
                            Logger.Current.Debug($"Skipping invalid culture file: {fileNameOnly}");
                        }
                    }
                }

                Logger.Current.Debug($"Found {cultures.Count} available translation cultures");
            }
            catch (Exception ex)
            {
                Logger.Current.LogException(LogLevels.Error, 
                    "Error getting available cultures", ex);
            }

            return cultures;
        }

        /// <summary>
        /// Clears the translation cache, forcing reload from files.
        /// </summary>
        public void RefreshTranslations()
        {
            LanguageRepository.GetInstance.ClearCache();
            Logger.Current.Info("Translation cache refreshed");
        }
        #endregion

        #region Private Methods
        private void LoadCultureFromConfig()
        {
            try
            {
                string cultureName = ConfigurationManager.AppSettings["Culture"];

                if (string.IsNullOrWhiteSpace(cultureName))
                {
                    cultureName = "en-US"; // Default culture
                    Logger.Current.Info($"No culture configured, using default: {cultureName}");
                }

                SetCultureInternal(cultureName);
                Logger.Current.Info($"Culture loaded from config: {cultureName}");
            }
            catch (Exception ex)
            {
                Logger.Current.LogException(LogLevels.Error, 
                    "Error loading culture from config, using default (en-US)", ex);
                SetCultureInternal("en-US");
            }
        }

        private void SetCultureInternal(string cultureName)
        {
            CultureInfo culture = new CultureInfo(cultureName);
            Thread.CurrentThread.CurrentCulture = culture;
            Thread.CurrentThread.CurrentUICulture = culture;

            // Also set default culture for new threads
            CultureInfo.DefaultThreadCurrentCulture = culture;
            CultureInfo.DefaultThreadCurrentUICulture = culture;
        }

        private void SaveCultureToConfig(string cultureName)
        {
            try
            {
                Configuration config = ConfigurationManager.OpenExeConfiguration(ConfigurationUserLevel.None);

                if (config.AppSettings.Settings["Culture"] == null)
                {
                    config.AppSettings.Settings.Add("Culture", cultureName);
                }
                else
                {
                    config.AppSettings.Settings["Culture"].Value = cultureName;
                }

                config.Save(ConfigurationSaveMode.Modified);
                ConfigurationManager.RefreshSection("appSettings");

                Logger.Current.Debug($"Culture '{cultureName}' saved to config file");
            }
            catch (Exception ex)
            {
                Logger.Current.LogException(LogLevels.Warning, 
                    $"Error saving culture '{cultureName}' to config file", ex);
            }
        }

        private void OnLanguageChanged()
        {
            try
            {
                LanguageChanged?.Invoke(this, EventArgs.Empty);
            }
            catch (Exception ex)
            {
                Logger.Current.LogException(LogLevels.Error, 
                    "Error in LanguageChanged event handler", ex);
            }
        }
        #endregion
    }
}
